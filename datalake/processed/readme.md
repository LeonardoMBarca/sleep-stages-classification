# Processed Feature Dictionary

This document explains the structure of the modelling-ready parquet tables generated by `src/data-processing/processed-for-data-for-model/processor.py`. Each row represents a **single 30-second epoch** with engineered features drawn from EEG, EOG, EMG, respiration, temperature, and temporal context.

---

## 1. Core Identifiers

| Column | Description |
|--------|-------------|
| `subject_id` | Sleep-EDFx subject (e.g., SC400, ST702) |
| `night_id`   | Recording night (`E0`, `E1`, …) |
| `epoch_idx`  | Epoch index within the night |
| `t0_sec`     | Epoch start timestamp (seconds from PSG start) |
| `stage`      | Sleep stage label ∈ {W, N1, N2, N3, REM} |
| `age`, `sex` | Demographic metadata (years, F/M) |
| `tso_min`    | Minutes since sleep onset (`max(0, (t0 - onset)/60)`) |

Train/validation/test partitions are stratified at the **subject level** (balanced by sex and age bin) to avoid leakage between splits.

---

## 2. Naming Conventions

```
CHANNEL_STAT_SUFFIX
```

- `EEG_Fpz_Cz_delta_relpow_256`: Fpz–Cz EEG, delta band, relative power, Welch window size 256.
- `EMG_submental_median_1hz`: Submental EMG, 1 Hz sampling, median amplitude.
- `EOG_rms_roll_mean_5`: Rolling (5-epoch) mean of EOG RMS.

Suffix hints:

| Suffix | Meaning |
|--------|---------|
| `_256`, `_512` | Welch PSD computed on 100 Hz channels with `nperseg=256/512` |
| `_1hz`, `_10hz` | Statistics from resampled 1 Hz / 10 Hz signals |
| `_roll_mean_k`, `_roll_std_k`, `_roll_max_k` | Rolling window over `k` epochs (2.5, 5, or 7.5 minutes) |

---

## 3. Spectral Features (100 Hz Channels)

Applied to EEG (Fpz–Cz, Pz–Oz), EOG, and telemetry EMG.

- **Band measures**: `pow`, `logpow`, `relpow`, and `peakfreq` for delta, theta, alpha, sigma, beta.
- **Ratios**: `delta_theta_ratio`, `theta_alpha_ratio`, `alpha_sigma_ratio`, `slow_fast_ratio`.
- **Global summaries**: `sef95`, `medfreq`, `spec_entropy`, `aperiodic_slope` over 0.5–30 Hz.
- **Time magnitude**: `rms`, `var` of the raw 100 Hz signal within the epoch.

These features capture stage-specific rhythms—delta dominance in N3, sigma spindles in N2, beta/alpha in wake, and eye-movement bursts in REM.

---

## 4. Low-Rate Time-Domain Features

Available for respiration, temperature, event markers, and 1 Hz submental EMG (cassette cohort).

- Statistics: mean, std, min, max, median, IQR, MAD, percentiles (p01/p10/p90/p99), skewness, kurtosis.
- Dynamics: `diff_rms`, `zcr`, linear `slope`.
- Quality flags: `Resp_oronasal_clip_frac_1hz`, `Temp_rectal_oor_frac_1hz` indicate clipped or out-of-range values.

Telemetry event markers are sampled at 10 Hz and follow the same naming pattern (`_10hz`). Treat them carefully to avoid label leakage—they reflect technician inputs rather than physiology.

---

## 5. Rolling Features

A subset of high-value signals receives rolling summaries to provide short-term history without violating causality:

| Window | Signals |
|--------|---------|
| 5 epochs | EEG/EOG band powers and ratios, EMG statistics |
| 10 epochs | Same signals, capturing slower drift |
| 15 epochs | Delta power, spectral entropy, aperiodic slope |

These correspond to ≈2.5, 5, and 7.5 minutes of context respectively.

---

## 6. Generated Artefacts

Running the processor script produces:

```
datalake/data-for-model/
├── train/train_sleep_cassette.parquet
├── val/val_sleep_cassette.parquet
├── test/test_sleep_cassette.parquet
├── sleep-cassette.parquet        # full dataset (all splits combined)
└── sleep-telemetry.parquet       # telemetry counterpart
```

Telemetry splitting follows the same logic if you run the script with telemetry data available.

---

Refer back to the project README for the full training pipeline and model export workflow.
